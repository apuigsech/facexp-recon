<!doctype html>
<html>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  </head>
  <body>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js" integrity="sha384-aCaxUP5DnkI7QE6SRaVW2z7cuxdMspuE4prBgfFMCLRhnUw7/Ws42SeDRbn3wPnw" crossorigin="anonymous"></script>

    <main>
      <div class="container mt-5">
        <div class="row">
          <div class="col-12 col-md-4 offset-md-4 text-center">
            <canvas id="output"></canvas>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-4 offset-md-4 text-center">
            <span id="lastOutput"></span>
          </div>
        </div>
      </div>
    </main>

    <script type="text/javascript">
      const EMOTIONS = [
        //'angry',
        //'disgust',
        //'fear',
        'happy', 
        'neutral', 
        'sad', 
        'surprise'
      ]
      async function main() {
        const model = await tf.loadLayersModel('models/modelConv/modelConv.json');

        //const camera = document.getElementById("camera");
        const canvas = document.getElementById("output");
        const context = canvas.getContext("2d");

        const spanOut = document.getElementById("lastOutput");

        var facedetector_options = {
          fastMode: true
        };

        var camera_options = {
          audio: false,
          video: {
            width: 480, height: 480,
            facingMode: "user"
          },
        };

        const faceDetector = new FaceDetector(facedetector_options);
        const mediaStream = await navigator.mediaDevices.getUserMedia(camera_options)
  
        const camera = document.createElement("video");
        camera.srcObject = mediaStream;
        camera.autoplay = true;
        camera.onloadedmetadata = () => {
          canvas.width = camera.videoWidth;
          canvas.height = camera.videoHeight;
        };

        setInterval(async function() {
          faceDetector
          .detect(camera)
          .then((faces) => {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(camera, 0, 0, camera.videoWidth, camera.videoHeight);

            context.strokeStyle = "#FFFF00";
            context.lineWidth = 5;
            faces.forEach((face) => {
              const { top, left, width, height } = face.boundingBox;

              console.log("Face in", top, left, width, height)

              context.beginPath();
              context.rect(left, top, width, height);
              context.stroke();
  /*
              const crop = document.createElement("canvas");
              crop.width = 48
              crop.height = 48
              const crop_ctx = canvas.getContext("2d");

              crop_ctx.drawImage(canvas, left, top, width, height, 0, 0, 48, 48)
              console.log(crop)
*/
              //imgData = crop_ctx.getImageData(0, 0, crop.width, crop.height)

              imgData = context.getImageData(left, top, height, width)

              context.putImageData(imgData, 10, 10);

              const image = tf.browser.fromPixels(crop_ctx.getImageData(0, 0, crop.width, crop.height))
                .mean(2)
                .toFloat()
                .div(255)
                .expandDims(-1)
                .reshape([-1, 48, 48, 1])

              tf.print(image)
              
              pred = model.predict(image) 
              a = Array.from(pred.dataSync())
              let i = a.indexOf(Math.max(...a));
              context.font = "30px Arial";
              context.fillStyle = "#FFFF00";
              context.fillText(EMOTIONS[i], left+30, top-10);
            })
          })

        }, 100);
      }
      main();
    </script>
  </body>
</html>